name: Deploy Docker to Hostinger

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env
          echo "DB_USER=${{ secrets.DB_USER }}" >> .env
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
          echo "DB_NAME=${{ secrets.DB_NAME }}" >> .env
          echo "DB_PORT=${{ secrets.DB_PORT }}" >> .env
          echo "DB_HOST=postgres-db" >> .env
          echo "PORT=${{ secrets.PORT }}" >> .env
          echo "NODE_ENV=production" >> .env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
          echo "PGADMIN_DEFAULT_EMAIL=${{ secrets.PGADMIN_DEFAULT_EMAIL }}" >> .env
          echo "PGADMIN_DEFAULT_PASSWORD=${{ secrets.PGADMIN_DEFAULT_PASSWORD }}" >> .env
          echo "PGADMIN_PORT=${{ secrets.PGADMIN_PORT }}" >> .env

      - name: Create deployment script
        run: |
          cat > deploy-docker.sh << 'EOFSCRIPT'
          #!/bin/bash
          set -e
          
          echo "üöÄ Iniciando deploy do Conecta Unifesspa..."
          
          # Navegar para o diret√≥rio do projeto
          cd "$(dirname "$0")"
          
          # Verificar se Docker est√° instalado
          if ! command -v docker &> /dev/null; then
              echo "‚ùå Docker n√£o est√° instalado!"
              exit 1
          fi
          
          # Parar containers antigos
          echo "üõë Parando containers antigos..."
          docker compose down || true
          
          # Build e start dos containers
          echo "üî® Construindo e iniciando containers..."
          docker compose up -d --build
          
          # Aguardar containers iniciarem
          echo "‚è≥ Aguardando containers iniciarem..."
          sleep 10
          
          # Verificar status
          echo "üìä Status dos containers:"
          docker compose ps
          
          # Verificar logs
          echo "üìã √öltimos logs:"
          docker compose logs --tail=20 app
          
          echo "‚úÖ Deploy conclu√≠do!"
          EOFSCRIPT
          
          chmod +x deploy-docker.sh

      - name: Deploy files to Hostinger via SFTP
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          username: ${{ secrets.SFTP_USER }}
          server: ${{ secrets.SFTP_HOST }}
          port: ${{ secrets.SFTP_PORT }}
          password: ${{ secrets.SFTP_PASSWORD }}
          local_path: "./"        
          remote_path: ${{ secrets.SFTP_TARGET }}
          sftp_only: true
          delete_remote_files: false
      
      - name: Deployment Instructions
        run: |
          echo "üì¶ Arquivos enviados com sucesso!"
          echo ""
          echo "‚ö†Ô∏è  ATEN√á√ÉO: Execute manualmente no servidor:"
          echo "1. Conecte-se ao servidor via SSH/Terminal da Hostinger"
          echo "2. Execute: cd ${{ secrets.SFTP_TARGET }}"
          echo "3. Execute: ./deploy-docker.sh"
          echo ""
          echo "Ou configure um webhook/cron job para executar automaticamente."
  
