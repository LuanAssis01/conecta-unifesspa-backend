name: Deploy to Hostinger via SFTP

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env
          echo "DB_USER=${{ secrets.DB_USER }}" >> .env
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
          echo "DB_NAME=${{ secrets.DB_NAME }}" >> .env
          echo "DB_PORT=${{ secrets.DB_PORT }}" >> .env
          echo "DB_HOST=postgres-db" >> .env
          echo "PORT=${{ secrets.PORT }}" >> .env
          echo "NODE_ENV=production" >> .env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
          echo "PGADMIN_DEFAULT_EMAIL=${{ secrets.PGADMIN_DEFAULT_EMAIL }}" >> .env
          echo "PGADMIN_DEFAULT_PASSWORD=${{ secrets.PGADMIN_DEFAULT_PASSWORD }}" >> .env
          echo "PGADMIN_PORT=${{ secrets.PGADMIN_PORT }}" >> .env

      - name: Deploy files to Hostinger via SFTP
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          username: ${{ secrets.SFTP_USER }}
          server: ${{ secrets.SFTP_HOST }}
          port: ${{ secrets.SFTP_PORT }}
          password: ${{ secrets.SFTP_PASSWORD }}
          local_path: "./"
          remote_path: ${{ secrets.SFTP_TARGET }}
          sftp_only: true
          delete_remote_files: false
      
      - name: Deployment Instructions
        run: |
          echo "ðŸ“¦ Arquivos enviados com sucesso via SFTP!"
          echo ""
          echo "âš ï¸  PRÃ“XIMOS PASSOS NO SERVIDOR:"
          echo ""
          echo "1. Acesse o Terminal SSH no hPanel da Hostinger"
          echo "2. Execute os comandos:"
          echo "   cd ${{ secrets.SFTP_TARGET }}"
          echo "   chmod +x deploy-docker.sh"
          echo "   ./deploy-docker.sh"
          echo ""
          echo "ðŸ’¡ Ou configure um cron job para executar automaticamente"
          echo "   */5 * * * * cd ${{ secrets.SFTP_TARGET }} && ./deploy-docker.sh >> /tmp/deploy.log 2>&1"
  
